<!-- d3 code based on  https://github.com/xoor-io/d3-canvas-example -->
{% extends "layout.html" %}
{% block content %}
<h3> Brain Region Specific eQTL in the heterogeneous stock rats </h3>
    <form class="form-inline my-2 my-lg-0" action="/plots" method="POST">
      <input name="loc" class="form-control mr-sm-2" type="search" placeholder="chr11:86735385" aria-label="search" value="chr11:86735385">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>

<div class="scatter-container"></div>
<script src="https://d3js.org/d3.v5.min.js"></script>

   
<script>

//convert data format
var graphData = {{ data.chart_data | safe }}
var dataExample=[];
for (var key in graphData){
  var entry = graphData[key];
  dataExample.push([entry["bp"], entry["p"]])
}

const pointColor = '#3585ff'
const margin = {top: 20, right: 15, bottom: 60, left: 70};
const outerWidth = 700;
const outerHeight = 500;
const width = outerWidth - margin.left - margin.right;
const height = outerHeight - margin.top - margin.bottom;
const container = d3.select('.scatter-container');

// Init SVG
const svgChart = container.append('svg:svg')
    .attr('width', outerWidth)
    .attr('height', outerHeight)
    .attr('class', 'svg-plot')
    .append('g')
    .attr('transform', `translate(${margin.left}, ${margin.top})`);

// Init Canvas
const canvasChart = container.append('canvas')
    .attr('width', width)
    .attr('height', height)
    .style('margin-left', margin.left + 'px')
    .style('margin-top', margin.top + 'px')
    .attr('class', 'canvas-plot');

const context = canvasChart.node().getContext('2d');


// Init Scales,modified 
const x = d3.scaleLinear()
	.domain([
			d3.min(dataExample, (d) => d[0]),
			d3.max(dataExample, (d) => d[0])
			])
	.range([0, width]).nice();

const y = d3.scaleLinear()
	.domain([
			d3.min(dataExample, (d) => d[1]),
			d3.max(dataExample, (d) => d[1])
	])
	.range([height, 0]).nice();


// Init Axis
const xAxis = d3.axisBottom(x);
const yAxis = d3.axisLeft(y);

// Add Axis
const gxAxis = svgChart.append('g')
    .attr('transform', `translate(0, ${height})`)
    .call(xAxis);
const gyAxis = svgChart.append('g')
    .call(yAxis);

// Add labels
svgChart.append('text')
    .attr('x', `-${height/2}`)
    .attr('dy', '-3.5em')
    .attr('transform', 'rotate(-90)')
    .text('-log10(p)');
svgChart.append('text')
    .attr('x', `${width/2}`)
    .attr('y', `${height + 40}`)
    .text('bp');


// Draw plot on canvas
function draw(transform) {
    const scaleX = transform.rescaleX(x);
    const scaleY = transform.rescaleY(y);

    gxAxis.call(xAxis.scale(scaleX));
    gyAxis.call(yAxis.scale(scaleY));

    context.clearRect(0, 0, width, height);

    dataExample.forEach( point => {
        drawPoint(scaleX, scaleY, point, transform.k);
    });
}

// Initial draw made with no zoom
draw(d3.zoomIdentity)

function drawPoint(scaleX, scaleY, point, k) {
    context.beginPath();
    context.fillStyle = pointColor;
    const px = scaleX(point[0]);
    const py = scaleY(point[1]);

    context.arc(px, py, 3 * k, 0, 2 * Math.PI, true);
    context.fill();
}

// Zoom/Drag handler
const zoom_function = d3.zoom().scaleExtent([1, 1000])
    .on('zoom', () => {
        const transform = d3.event.transform;
        context.save();
        draw(transform);
        context.restore();
    });

canvasChart.call(zoom_function);
	
</script>
{% endblock %}
